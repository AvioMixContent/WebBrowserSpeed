import React, { useState, useEffect, useCallback, memo } from 'react'; // Import memo
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

// Data for each PC configuration, including browser performance scores
// Defined outside components to prevent re-creation on every render
const configurations = {
    'config1': { // i7 13980HX, RTX 4090 laptop, 32 GB DDR5 4800 MHz
        edge: 35.5,
        chrome: 35.2,
        firefox: 26.0,
        brave: 33.6,
        opera: 32.2,
        safari: 0.0
    },
    'config2': { // 7800X3D, RTX 4080 Super, 32 GB RAM DDR5 6000 MHz @ CL 28
        edge: 34.9,
        chrome: 34.8,
        firefox: 28.5,
        brave: 34.1,
        opera: 33.5,
        safari: 0.0
    },
    'config3': { // i5 10400, 16 GB DDR5 2666 MHz
        edge: 18.3,
        chrome: 17.3,
        firefox: 14.9,
        brave: 17.1,
        opera: 16.2,
        safari: 0.0
    },
    'config4': { // i7 10750H, RTX 2070 Super laptop, 16 GB DDR5 2666 MHz
        edge: 19.0,
        chrome: 18.7,
        firefox: 15.5,
        brave: 18.5,
        opera: 17.8,
        safari: 0.0
    }
};

// Browser logo URLs
// Defined outside components for performance
const browserLogos = {
    edge: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/Microsoft_Edge_logo_%282019%29.svg/48px-Microsoft_Edge_logo_%282019%29.svg.png',
    chrome: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Google_Chrome_icon_%28September_2014%29.svg/48px-Google_Chrome_icon_%28September_2014%29.svg.png',
    brave: 'https://upload.wikimedia.org/wikipedia/commons/5/51/Brave_icon_lionface.png',
    opera: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Opera_2015_icon.svg/48px-Opera_2015_icon.svg.png',
    firefox: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Firefox_logo%2C_2019.svg/48px-Firefox_logo%2C_2019.svg.png',
    safari: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Safari_browser_logo.svg/48px-Safari_browser_logo.svg.png',
};


// Header Component: Displays contact and social media links
// Memoized as its props are static
const Header = memo(() => (
    <header className="w-full max-w-5xl mx-auto bg-gray-900 h-8 flex items-center justify-end px-4 shadow-lg rounded-b-xl">
        <div className="flex items-center space-x-2">
            <a href="mailto:info@example.com" className="text-gray-300 flex items-center hover:text-white transition-colors duration-200 text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-mail mr-1"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                info@example.com
            </a>
            <a href="https://www.facebook.com/yourpage" target="_blank" rel="noopener noreferrer" className="text-gray-300 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-facebook"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
            </a>
            <a href="https://www.instagram.com/yourprofile" target="_blank" rel="noopener noreferrer" className="text-gray-300 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-instagram"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>
            </a>
        </div>
    </header>
));

// Page Header Component: Displays the Speedometer title and logo
// Memoized as its props are static
const PageHeader = memo(() => (
    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 sm:mb-8">
        <div className="flex items-center mb-4 sm:mb-0">
            {/* SVG for the gauge logo with a linear gradient effect */}
            <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="url(#logo-gradient)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-gauge mr-6">
                <defs>
                    <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#22c55e" stopOpacity="1" />
                        <stop offset="33%" stopColor="#facc15" stopOpacity="1" />
                        <stop offset="66%" stopColor="#f97316" stopOpacity="1" />
                        <stop offset="100%" stopColor="#ef4444" stopOpacity="1" />
                    </linearGradient>
                </defs>
                <path d="m12 14 4-4"/>
                <path d="M3.34 19.06a10 10 0 1 1 17.32 0"/>
            </svg>
            <div className="flex flex-col items-start">
                {/* Changed order and font sizes as per user request, using text-black */}
                <h1 className="text-xl sm:text-2xl font-bold leading-tight text-black">Browsers Performance Overview</h1>
                <h1 className="text-xs sm:text-sm font-bold leading-tight text-black">Speedometer 3.1</h1>
            </div>
        </div>
    </div>
));

// Navigation Component: Allows selecting different PC configurations
// Memoized to prevent re-renders unless selectedConfig or onSelectConfig changes
const Navigation = memo(({ selectedConfig, onSelectConfig }) => (
    <nav className="w-full mb-6 sm:mb-8">
        <ul className="flex flex-wrap justify-center gap-2">
            {Object.keys(configurations).map((configKey) => (
                <li key={configKey} className="flex-1 min-w-0">
                    <button
                        className={`w-full px-2 py-2 rounded-lg text-xs font-semibold border-2 transition-all duration-300 ease-in-out shadow-sm text-center
                            ${selectedConfig === configKey
                                ? (configKey === 'config2' ? 'bg-green-600 border-green-600 text-white shadow-md' : 'bg-blue-600 border-blue-600 text-white shadow-md')
                                : (configKey === 'config2' ? 'bg-white border-green-300 text-gray-700 hover:bg-green-50 hover:border-green-400' : 'bg-white border-blue-300 text-gray-700 hover:bg-blue-50 hover:border-blue-400')
                            }
                            focus:outline-none focus:ring-2 focus:ring-offset-2
                            ${configKey === 'config2' ? 'focus:ring-green-500' : 'focus:ring-blue-500'}
                            active:scale-98
                        `}
                        onClick={() => onSelectConfig(configKey)}
                    >
                        {configKey === 'config1' && (<>i7 13980HX<br/>RTX 4090 laptop<br/>32 GB DDR5 4800 MHz</>)}
                        {configKey === 'config2' && (<>7800X3D<br/>RTX 4080 Super<br/>32 GB DDR5 6000 MHz CL 28</>)}
                        {configKey === 'config3' && (<>i5 10400<br/>-<br/>16 GB DDR5 2666 MHz</>)}
                        {configKey === 'config4' && (<>i7 10750H<br/>RTX 2070 Super laptop<br/>16 GB DDR5 2666 MHz</>)}
                    </button>
                </li>
            ))}
        </ul>
    </nav>
));

// Hero Section Component: Displays a promotional banner
// Memoized as its props are static
const HeroSection = memo(() => (
    <div className="relative w-full h-40 rounded-xl overflow-hidden shadow-xl mb-8">
        <img src="https://placehold.co/800x160/333333/FFFFFF?text=Optimize+your+online+experience" alt="Abstract speed background" className="absolute inset-0 w-full h-full object-cover filter brightness-75" loading="lazy"/>
        <div className="relative z-10 flex flex-col items-center justify-center h-full p-4 text-white bg-black bg-opacity-30">
            <h2 className="text-3xl font-extrabold mb-2 drop-shadow-lg">Discover which browser is the fastest!</h2>
            <p className="text-lg text-gray-100 drop-shadow-md">Our tests reveal real performance.</p>
        </div>
    </div>
));

// Browser Card Component: Displays individual browser performance
// Memoized to prevent re-renders unless its specific props (browserName, score, maxScore) change
const BrowserCard = memo(({ browserName, score, maxScore }) => {
    const isSafariNA = browserName === 'safari' && score === 0;
    const barWidth = `calc((${score} / ${maxScore}) * 100%)`;

    // Helper functions to return full, static Tailwind class strings
    const getBarBgClass = (name, isNA) => {
        if (isNA) return 'bg-gray-400';
        switch (name) {
            case 'edge': return 'bg-teal-500';
            case 'chrome': return 'bg-yellow-400';
            case 'firefox': return 'bg-orange-500';
            case 'brave': return 'bg-amber-500';
            case 'opera': return 'bg-red-500';
            case 'safari': return 'bg-blue-500';
            default: return 'bg-gray-500'; // Fallback
        }
    };

    const getBorderClass = (name, isNA) => {
        if (isNA) return 'border-gray-300';
        switch (name) {
            case 'edge': return 'border-teal-400';
            case 'chrome': return 'border-yellow-300';
            case 'firefox': return 'border-orange-400';
            case 'brave': return 'border-amber-400';
            case 'opera': return 'border-red-400';
            case 'safari': return 'border-blue-400';
            default: return 'border-gray-400'; // Fallback
        }
    };

    const scoreTextClass = isSafariNA ? 'text-gray-600' : 'text-gray-600'; // Still consistent

    return (
        <div className={`
            bg-white rounded-2xl shadow-lg p-5 flex flex-col items-center text-center border-2
            ${getBorderClass(browserName, isSafariNA)}
            hover:scale-103 hover:shadow-2xl transition-all duration-300 ease-in-out
        `} data-browser={browserName}>
            <img
                src={browserLogos[browserName]}
                alt={`${browserName} browser logo`}
                className="w-14 h-14 mb-3"
                onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/56x56/cccccc/000000?text=${browserName}`; }}
                loading="lazy"
            />
            <p className="font-semibold text-xl text-gray-800 mb-2 capitalize">{browserName}</p>
            <div className="w-full h-8 bg-gray-200 rounded-lg overflow-hidden flex items-center">
                <div className={`h-full ${getBarBgClass(browserName, isSafariNA)} rounded-lg`} style={{ width: barWidth }}></div>
            </div>
            <div className="flex items-baseline mt-3">
                <span className="font-bold text-3xl text-gray-900 mr-1">
                    {score.toFixed(1)}
                </span>
                <span className={`text-base ${scoreTextClass}`}>
                    {isSafariNA ? '(Not available / Not tested)' : 'points'}
                </span>
            </div>
        </div>
    );
});

// Main Content Wrapper Component: Contains the page header, navigation, hero, and browser cards
const MainContent = ({ selectedConfig, onSelectConfig }) => {
    const [browserScores, setBrowserScores] = useState([]);
    const maxScore = 50; // Maximum score for scaling the bars

    // Effect to update browser scores when the selected configuration changes
    useEffect(() => {
        if (configurations[selectedConfig]) {
            // Convert scores object to an array of objects for sorting
            const currentScores = Object.entries(configurations[selectedConfig]).map(([name, score]) => ({
                name,
                score
            }));
            // Sort by score in descending order
            currentScores.sort((a, b) => b.score - a.score);
            setBrowserScores(currentScores);
        }
    }, [selectedConfig]); // Dependency array includes selectedConfig

    return (
        <div className="w-full max-w-5xl bg-white px-6 pt-6 pb-6 sm:px-8 sm:pb-8 md:px-10 md:pb-10 rounded-xl shadow-2xl">
            <PageHeader />
            <Navigation selectedConfig={selectedConfig} onSelectConfig={onSelectConfig} />
            <HeroSection />

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8" id="browser-cards-container">
                {browserScores.map((browser) => (
                    <BrowserCard
                        key={browser.name}
                        browserName={browser.name}
                        score={browser.score}
                        maxScore={maxScore}
                    />
                ))}
            </div>

            <p className="text-center text-gray-500 text-sm mt-10">
                Tested on 26.5.2025. Browser versions are always the latest as of the testing date.
            </p>
        </div>
    );
};

// Footer Component: Displays copyright information
// Memoized as its props are static
const Footer = memo(() => (
    <footer className="w-full max-w-5xl mx-auto bg-gray-900 text-white text-center py-4 shadow-lg rounded-t-xl">
        <p className="text-sm">&copy; 2025 Web Browser Speed. All rights reserved.</p>
    </footer>
));

// Main App Component: Orchestrates all other components
const App = () => {
    // Firebase initialization boilerplate.
    // Note: This app does not actively use Firestore for data persistence,
    // but the Firebase setup is included as per environment requirements.
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    useEffect(() => {
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            setDb(getFirestore(app));
            setAuth(getAuth(app));
        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
        }
    }, []); // Empty dependency array ensures this runs only once on mount

    useEffect(() => {
        if (auth) {
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        setUserId(auth.currentUser?.uid || crypto.randomUUID());
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                        setUserId(crypto.randomUUID()); // Fallback to a random ID
                    }
                }
            });
            return () => unsubscribe(); // Cleanup subscription on unmount
        }
    }, [auth]); // Reruns if auth object changes

    // State to manage the currently selected PC configuration
    const [selectedConfig, setSelectedConfig] = useState('config1');

    // Callback function to update the selected configuration
    // Memoized with useCallback to prevent unnecessary re-renders of Navigation
    const handleSelectConfiguration = useCallback((configKey) => {
        setSelectedConfig(configKey);
    }, []); // Empty dependency array ensures this function is stable across renders

    return (
        <div className="flex flex-col items-center min-h-screen bg-gray-50 font-inter">
            {/* This hidden div is a workaround for Tailwind CSS CDN's JIT mode.
                When using Tailwind via CDN, the JIT compiler scans your HTML/JSX to find classes.
                By explicitly listing all possible dynamic class combinations here,
                we "force" the JIT compiler to include these styles in the generated CSS.
                For a production environment, a full Tailwind build process (using PostCSS)
                is generally recommended over the CDN for better reliability and optimization.
            */}
            {/* This hidden div is now less critical for BrowserCard's dynamic classes
                due to explicit class definitions within BrowserCard, but it's kept
                for other potential dynamic classes or general robustness with CDN. */}
            <div className="hidden">
                {/* Browser Card Colors - these are now mostly handled explicitly in BrowserCard */}
                <div className="border-teal-400 bg-teal-500"></div>
                <div className="border-yellow-300 bg-yellow-400"></div>
                <div className="border-orange-400 bg-orange-500"></div>
                <div className="border-amber-400 bg-amber-500"></div>
                <div className="border-red-400 bg-red-500"></div>
                <div className="border-blue-400 bg-blue-500"></div>
                <div className="border-gray-300 bg-gray-400"></div>

                {/* Navigation Button Colors (active state) */}
                <div className="bg-green-600 border-green-600 text-white shadow-md"></div>
                <div className="bg-blue-600 border-blue-600 text-white shadow-md"></div>

                {/* Navigation Button Colors (default state) */}
                <div className="bg-white border-green-300 text-gray-700"></div>
                <div className="bg-white border-blue-300 text-gray-700"></div>

                {/* Navigation Button Hover States */}
                <div className="hover:bg-green-50 hover:border-green-400"></div>
                <div className="hover:bg-blue-50 hover:border-blue-400"></div>

                {/* Navigation Button Focus Ring States */}
                <div className="focus:ring-green-500"></div>
                <div className="focus:ring-blue-500"></div>

                {/* Browser Card Hover Effects */}
                <div className="hover:scale-103 hover:shadow-2xl"></div>
            </div>
            <Header />
            <MainContent selectedConfig={selectedConfig} onSelectConfig={handleSelectConfiguration} />
            <Footer />
        </div>
    );
};

export default App;
